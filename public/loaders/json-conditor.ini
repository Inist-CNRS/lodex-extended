append = dump
label = json-conditor

# load some plugins to activate some statements
[use]
plugin = basics

# Toggle ezs traces (see server stderr log)
[debug]
ezs = false

# Parse input file
[unpack]

[assign]
path = ApilCollation
value = get("host.volume") \
        .concat(_.get(self,"host.issue")) \
        .concat(_.get(self,"host.pages.range")) \
        .join(" / ")

path = ApilProvenance
value = get("sourceUids").castArray().map(s => s.split("$")[0]).uniq()

[exchange]
value = omit(['ws'])

# Aplatit la structure, pour avoir le mÃªme comportement que le loader
# json-optimized.ini
# https://github.com/Inist-CNRS/lodex-extended/blob/master/public/loaders/json-optimized.ini
[OBJFlatten]
separator = fix('/')
safe = true

# Ensures that each object contains an identification key (required by lodex)
[swing]
test = pick(['URI', 'uri']).pickBy(_.identity).isEmpty()
[swing/identify]

# Prevent keys from containing dot path notation (which is forbidden by nodejs mongoDB driver)
[OBJFlatten]
separator = fix('.')
reverse = true
safe = true

# Uncomment to see each data sent to the database
#[debug]

# Add contextual metadata related to the import
[assign]
path = lodexStamp.importedDate
value = fix(new Date()).thru(d => d.toDateString())
path = lodexStamp.usedParser
value = env('parser')
path = lodexStamp.uploadedFilename
value = env('source')
